<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fusion Square - Mobile</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; touch-action: none; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #ffffff; 
            min-height: 100vh; min-height: -webkit-fill-available;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 10px;
        }
        .top-spacer { flex: 1; }
        .game-container { background: #ffffff; border-radius: 8%; box-shadow: 0 8px 30px rgba(0,0,0,0.12); }
        .game-area { 
            position: relative; width: min(92vw, 55vh); height: min(92vw, 55vh);
            background: #ffffff; border-radius: 8%; overflow: hidden; 
        }
        /* Zones grises - grille 7x7, chaque cellule = 14.28% */
        .crown-zone { display: none; }
        .crown-zone-c1 { display: none; }
        .crown-zone-c2 { display: none; }
        .crown-zone-c3 { display: none; }
        .crown-zone-center { display: none; }
        
        /* Rails - passent par le CENTRE des cellules (pas les bords!)
           Grille 7x7 avec padding ~5% de chaque côté
           Cellule 0: centre à ~5% + (100%-10%)/7 * 0.5 = ~11.4%
           Cellule 1: centre à ~5% + (100%-10%)/7 * 1.5 = ~24.3%
           Cellule 2: centre à ~5% + (100%-10%)/7 * 2.5 = ~37.1%
        */
        .rail { position: absolute; border: 2px dashed rgba(100,100,100,0.4); pointer-events: none; z-index: 2; }
        .rail.dragging { border-color: #ffd700; border-style: solid; border-width: 3px; box-shadow: 0 0 15px rgba(255,215,0,0.4); }
        .rail.snapping { border-color: #00ff88; border-style: solid; border-width: 3px; box-shadow: 0 0 20px rgba(0,255,136,0.5); }
        /* Ces valeurs seront recalculées en JS pour être exactes */
        .rail-c1 { top: 11.4%; left: 11.4%; right: 11.4%; bottom: 11.4%; }
        .rail-c2 { top: 24.3%; left: 24.3%; right: 24.3%; bottom: 24.3%; }
        .rail-c3 { top: 37.1%; left: 37.1%; right: 37.1%; bottom: 37.1%; }
        
        .center-sun { 
            width: 12%; height: 12%; 
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffa500 100%); 
            border-radius: 15%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            box-shadow: 0 0 20px rgba(255,215,0,0.5); cursor: grab; z-index: 100; 
            border: 2px solid rgba(255,255,255,0.9);
        }
        .center-sun.dragging { transform: translate(-50%, -50%) scale(1.15); box-shadow: 0 0 30px rgba(255,215,0,0.7); }
        .pastille { position: absolute; border-radius: 15%; box-shadow: 0 2px 6px rgba(0,0,0,0.3); cursor: grab; z-index: 10; }
        .pastille.blocked { animation: shake 0.3s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .bottom-menu { display: flex; flex-direction: column; gap: 6px; padding: 10px; background: #1a1a2e; border-radius: 15px; width: 100%; max-width: min(95vw, 400px); }
        .controls { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; align-items: center; }
        .control-item { background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 12px; display: flex; align-items: center; gap: 4px; font-size: 0.7em; color: white; }
        button { padding: 6px 12px; font-size: 0.75em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: bold; }
        .toggle-switch { position: relative; width: 32px; height: 18px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; inset: 0; background-color: rgba(255,255,255,0.2); border-radius: 18px; }
        .toggle-slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.2s; }
        input:checked + .toggle-slider { background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); }
        input:checked + .toggle-slider:before { transform: translateX(14px); }
        .legend { display: flex; gap: 6px; font-size: 0.6em; flex-wrap: wrap; justify-content: center; color: white; }
        .legend-item { display: flex; align-items: center; gap: 3px; }
        .legend-dot { width: 12px; height: 12px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="top-spacer"></div>
    <div class="game-container">
        <div class="game-area" id="gameArea">
            <div class="crown-zone crown-zone-c1"></div>
            <div class="crown-zone crown-zone-c2"></div>
            <div class="crown-zone crown-zone-c3"></div>
            <div class="crown-zone crown-zone-center"></div>
            <div class="rail rail-c1"></div>
            <div class="rail rail-c2"></div>
            <div class="rail rail-c3"></div>
            <div class="center-sun" id="centerSun"></div>
        </div>
    </div>
    <div class="bottom-menu">
        <div class="controls">
            <div class="control-item"><label>Rails:</label><label class="toggle-switch"><input type="checkbox" id="showRails" checked onchange="toggleRails()"><span class="toggle-slider"></span></label></div>
            <div class="control-item"><label>Pastilles:</label><label class="toggle-switch"><input type="checkbox" id="showPastilles" checked onchange="togglePastilles()"><span class="toggle-slider"></span></label></div>
            <div class="control-item"><label>Soleil:</label><label class="toggle-switch"><input type="checkbox" id="showSoleil" checked onchange="toggleSoleil()"><span class="toggle-slider"></span></label></div>
            <button onclick="init()">Reset</button>
        </div>
        <div class="controls">
            <div class="control-item"><label>Taille:</label><input type="range" id="sizePastille" min="10" max="50" value="22" oninput="updateSizes()" style="width:50px;"></div>
            <div class="control-item"><label>Ancrage:</label><input type="range" id="sizeAncrage" min="20" max="80" value="45" oninput="updateSizes()" style="width:50px;"></div>
            <div class="control-item"><label>Arrondi:</label><input type="range" id="radiusPastille" min="0" max="50" value="15" oninput="updateSizes()" style="width:50px;"></div>
        </div>
        <div class="legend">
            <div class="legend-item"><div class="legend-dot" style="background:#3498db;"></div><span>Bleu</span></div>
            <div class="legend-item"><div class="legend-dot" style="background:#f1c40f;"></div><span>Jaune</span></div>
            <div class="legend-item"><div class="legend-dot" style="background:#e74c3c;"></div><span>Rouge</span></div>
            <div class="legend-item"><div class="legend-dot" style="background:#2ecc71;"></div><span>Vert</span></div>
            <div class="legend-item"><div class="legend-dot" style="background:#9b59b6;"></div><span>Violet</span></div>
            <div class="legend-item"><div class="legend-dot" style="background:#e67e22;"></div><span>Orange</span></div>
        </div>
    </div>
    <script>
        let canvasSize=520,cx=260,cy=260,padding,cellSize;
        const gridSize=7;
        
        function updateDimensions(){
            const ga=document.getElementById('gameArea');
            canvasSize=ga.offsetWidth;
            cx=canvasSize/2;
            cy=canvasSize/2;
            padding=canvasSize*0.05;
            cellSize=(canvasSize-2*padding)/gridSize;
            
            // Mettre à jour les rails pour qu'ils passent par le CENTRE des cellules
            updateRailPositions();
        }
        
        function updateRailPositions(){
            // Centre de la cellule 0 = padding + cellSize/2
            // Centre de la cellule 1 = padding + cellSize*1.5
            // Centre de la cellule 2 = padding + cellSize*2.5
            const c0 = (padding + cellSize * 0.5) / canvasSize * 100;
            const c1 = (padding + cellSize * 1.5) / canvasSize * 100;
            const c2 = (padding + cellSize * 2.5) / canvasSize * 100;
            
            const rail1 = document.querySelector('.rail-c1');
            const rail2 = document.querySelector('.rail-c2');
            const rail3 = document.querySelector('.rail-c3');
            
            if(rail1) { rail1.style.top = c0+'%'; rail1.style.left = c0+'%'; rail1.style.right = c0+'%'; rail1.style.bottom = c0+'%'; }
            if(rail2) { rail2.style.top = c1+'%'; rail2.style.left = c1+'%'; rail2.style.right = c1+'%'; rail2.style.bottom = c1+'%'; }
            if(rail3) { rail3.style.top = c2+'%'; rail3.style.left = c2+'%'; rail3.style.right = c2+'%'; rail3.style.bottom = c2+'%'; }
        }
        
        const c1Positions=[[0,0],[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[1,6],[2,6],[3,6],[4,6],[5,6],[6,6],[6,5],[6,4],[6,3],[6,2],[6,1],[6,0],[5,0],[4,0],[3,0],[2,0],[1,0]];
        const c2Positions=[[1,1],[1,2],[1,3],[1,4],[1,5],[2,5],[3,5],[4,5],[5,5],[5,4],[5,3],[5,2],[5,1],[4,1],[3,1],[2,1]];
        const c3Positions=[[2,2],[2,3],[2,4],[3,4],[4,4],[4,3],[4,2],[3,2]];
        const crownPositions=[c1Positions,c2Positions,c3Positions];
        const crowns=[{count:24},{count:16},{count:8}];
        
        let sizePastille=22,sizeAncrage=45,radiusPastille=15;
        let data=[[],[],[]],offsets=[0,0,0],centerColor=1;
        const pastilleColors=["#3498db","#f1c40f","#e74c3c","#2ecc71","#9b59b6","#e67e22","#bdc3c7"];
        const fusionRules={'0-1':3,'1-0':3,'0-2':4,'2-0':4,'1-2':5,'2-1':5};
        const fissionRules={'3-6':[0,1],'4-6':[0,2],'5-6':[2,1],'6-3':[1,0],'6-4':[2,0],'6-5':[1,2]};
        
        let audioCtx=null;
        function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
        function playTick(){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.value=800;o.type='sine';g.gain.setValueAtTime(0.3,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.05);o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+0.05);}
        function playFusionSound(){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.value=523.25;o.type='sine';g.gain.setValueAtTime(0.3,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.2);o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+0.2);}
        function playFissionSound(){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.setValueAtTime(659.25,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(329.63,audioCtx.currentTime+0.2);o.type='sine';g.gain.setValueAtTime(0.3,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.25);o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+0.25);}
        function playBlockedSound(){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.value=200;o.type='square';g.gain.setValueAtTime(0.2,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.1);o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+0.1);}
        function playDiagonalSound(){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.value=440;o.type='triangle';g.gain.setValueAtTime(0.25,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.15);o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+0.15);}
        
        function getPositionOnSquare(crown,index){
            const positions=crownPositions[crown],count=positions.length;
            const realIndex=((index+offsets[crown])%count+count)%count;
            const idx1=Math.floor(realIndex),idx2=(idx1+1)%count,t=realIndex-idx1;
            const[row1,col1]=positions[idx1],[row2,col2]=positions[idx2];
            const row=row1+(row2-row1)*t,col=col1+(col2-col1)*t;
            const x=padding+col*cellSize+cellSize/2,y=padding+row*cellSize+cellSize/2;
            return{x,y};
        }
        function getGridPosition(crown,index){
            const positions=crownPositions[crown],count=positions.length;
            const offsetIndex=Math.round(offsets[crown]);
            return positions[((index+offsetIndex)%count+count)%count];
        }
        
        let colorPool=[];
        function initColorPool(){colorPool=[];for(let c=0;c<3;c++)for(let i=0;i<16;i++)colorPool.push(c);for(let i=colorPool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[colorPool[i],colorPool[j]]=[colorPool[j],colorPool[i]];}}
        function getNextColor(){return colorPool.length>0?colorPool.pop():Math.floor(Math.random()*3);}
        
        function createPastille(colorIdx,crown,index){
            const anchor=document.createElement('div');
            anchor.className='pastille-anchor';
            anchor.style.cssText='position:absolute;width:'+sizeAncrage+'px;height:'+sizeAncrage+'px;display:flex;justify-content:center;align-items:center;';
            anchor.dataset.crown=crown;anchor.dataset.index=index;
            const elem=document.createElement('div');
            elem.className='pastille';
            elem.style.cssText='width:'+sizePastille+'px;height:'+sizePastille+'px;border-radius:'+radiusPastille+'%;background:'+pastilleColors[colorIdx]+';position:relative;';
            anchor.appendChild(elem);
            document.getElementById('gameArea').appendChild(anchor);
            return{anchor,elem};
        }
        function positionPastille(anchor,crown,index){const pos=getPositionOnSquare(crown,index);anchor.style.left=(pos.x-sizeAncrage/2)+'px';anchor.style.top=(pos.y-sizeAncrage/2)+'px';}
        function updateAllPositions(){for(let c=0;c<3;c++)for(let i=0;i<data[c].length;i++)if(data[c][i] && data[c][i].anchor)positionPastille(data[c][i].anchor,c,i);}
        function updateCenterSunColor(){const sun=document.getElementById('centerSun');sun.style.background=centerColor===1?'linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffa500 100%)':pastilleColors[centerColor];}
        
        function updateSizes(){
            sizePastille=parseInt(document.getElementById('sizePastille').value);
            sizeAncrage=parseInt(document.getElementById('sizeAncrage').value);
            radiusPastille=parseInt(document.getElementById('radiusPastille').value);
            for(let c=0;c<3;c++)for(let i=0;i<data[c].length;i++){
                if(!data[c][i]) continue;
                const{anchor,elem}=data[c][i];
                if(anchor&&elem){anchor.style.width=sizeAncrage+'px';anchor.style.height=sizeAncrage+'px';elem.style.width=sizePastille+'px';elem.style.height=sizePastille+'px';elem.style.borderRadius=radiusPastille+'%';}
            }
            updateAllPositions();
        }
        function toggleRails(){document.querySelectorAll('.rail').forEach(r=>r.style.opacity=document.getElementById('showRails').checked?'1':'0');}
        function togglePastilles(){document.querySelectorAll('.pastille-anchor').forEach(p=>p.style.display=document.getElementById('showPastilles').checked?'flex':'none');}
        function toggleSoleil(){document.getElementById('centerSun').style.display=document.getElementById('showSoleil').checked?'flex':'none';}
        
        let activeDrag=null;
        function getAngle(x,y){return Math.atan2(y-cy,x-cx);}
        
        function findHVNeighbors(sourceCrown,sourceIndex){
            const[sourceRow,sourceCol]=getGridPosition(sourceCrown,sourceIndex),targets=[];
            const directions=[{dr:-1,dc:0,name:'up'},{dr:1,dc:0,name:'down'},{dr:0,dc:-1,name:'left'},{dr:0,dc:1,name:'right'}];
            for(const dir of directions){
                const newRow=sourceRow+dir.dr,newCol=sourceCol+dir.dc;
                if(newRow<0||newRow>6||newCol<0||newCol>6)continue;
                if(newRow===3&&newCol===3){targets.push({type:'center',direction:dir.name,dr:dir.dr,dc:dir.dc});continue;}
                for(let c=0;c<3;c++){
                    if(c===sourceCrown)continue;
                    const positions=crownPositions[c],offset=Math.round(offsets[c]);
                    for(let i=0;i<positions.length;i++){
                        const posIdx=((i+offset)%positions.length+positions.length)%positions.length;
                        const[r,col2]=positions[posIdx];
                        if(r===newRow&&col2===newCol){targets.push({type:'crown',crown:c,index:i,direction:dir.name,dr:dir.dr,dc:dir.dc});break;}
                    }
                }
            }
            return targets;
        }
        
        function findDiagonalNeighbors(row,col){
            const neighbors=[],diagonals=[[-1,-1],[-1,1],[1,-1],[1,1]];
            for(const[dr,dc]of diagonals){
                const newRow=row+dr,newCol=col+dc;
                if(newRow<0||newRow>6||newCol<0||newCol>6)continue;
                if(newRow===3&&newCol===3){neighbors.push({type:'center',dr,dc});continue;}
                for(let c=0;c<3;c++){
                    const positions=crownPositions[c],offset=Math.round(offsets[c]);
                    for(let i=0;i<positions.length;i++){
                        const posIdx=((i+offset)%positions.length+positions.length)%positions.length;
                        const[r,col2]=positions[posIdx];
                        if(r===newRow&&col2===newCol){neighbors.push({type:'crown',crown:c,index:i,dr,dc});break;}
                    }
                }
            }
            return neighbors;
        }
        
        function handleStart(e){
            const target=e.target,ga=document.getElementById('gameArea'),rect=ga.getBoundingClientRect();
            const px=e.touches?e.touches[0].clientX:e.clientX,py=e.touches?e.touches[0].clientY:e.clientY;
            const x=px-rect.left,y=py-rect.top;
            initAudio();
            
            if(target.id==='centerSun'){
                activeDrag={type:'centerDiagonal',startX:x,startY:y,neighbors:findDiagonalNeighbors(3,3)};
                target.classList.add('dragging');
                e.preventDefault();return;
            }
            
            let anchor=null;
            if(target.classList.contains('pastille'))anchor=target.parentElement;
            else if(target.classList.contains('pastille-anchor'))anchor=target;
            
            if(anchor){
                const crown=parseInt(anchor.dataset.crown),index=parseInt(anchor.dataset.index);
                const pos=getPositionOnSquare(crown,index);
                activeDrag={type:'pastilleDetect',anchor,crown,index,startX:x,startY:y,posX:pos.x,posY:pos.y};
                e.preventDefault();
            }
        }
        
        function handleMove(e){
            if(!activeDrag)return;
            const ga=document.getElementById('gameArea'),rect=ga.getBoundingClientRect();
            const px=e.touches?e.touches[0].clientX:e.clientX,py=e.touches?e.touches[0].clientY:e.clientY;
            const x=px-rect.left,y=py-rect.top;
            const dx=x-activeDrag.startX,dy=y-activeDrag.startY,dist=Math.sqrt(dx*dx+dy*dy);
            
            if(activeDrag.type==='pastilleDetect'&&dist>15){
                const angle=Math.atan2(dy,dx)*180/Math.PI,absAngle=Math.abs(angle);
                const isDiagonal=(absAngle>30&&absAngle<60)||(absAngle>120&&absAngle<150);
                
                if(isDiagonal){
                    const[row,col]=getGridPosition(activeDrag.crown,activeDrag.index);
                    activeDrag.type='diagonal';
                    activeDrag.neighbors=findDiagonalNeighbors(row,col);
                }else{
                    const radialDirX=activeDrag.posX-cx,radialDirY=activeDrag.posY-cy;
                    const radialLen=Math.sqrt(radialDirX*radialDirX+radialDirY*radialDirY);
                    const radialNormX=radialDirX/radialLen,radialNormY=radialDirY/radialLen;
                    const tangentNormX=-radialNormY,tangentNormY=radialNormX;
                    const dragNormX=dx/dist,dragNormY=dy/dist;
                    const tangentProj=Math.abs(dragNormX*tangentNormX+dragNormY*tangentNormY);
                    const radialProj=Math.abs(dragNormX*radialNormX+dragNormY*radialNormY);
                    
                    if(tangentProj>radialProj){
                        activeDrag.type='crownRotation';
                        activeDrag.startAngle=getAngle(x,y);
                        activeDrag.startOffset=offsets[activeDrag.crown];
                        const railClass=['rail-c1','rail-c2','rail-c3'][activeDrag.crown];
                        const rail=document.querySelector('.'+railClass);
                        if(rail)rail.classList.add('dragging');
                    }else{
                        let hvDirection;
                        if(Math.abs(dx)>Math.abs(dy))hvDirection=dx>0?'right':'left';
                        else hvDirection=dy>0?'down':'up';
                        
                        const allTargets=findHVNeighbors(activeDrag.crown,activeDrag.index);
                        const targets=allTargets.filter(t=>t.direction===hvDirection);
                        
                        if(targets.length>0){
                            const targetInfo=targets[0];
                            const sourceColor=data[activeDrag.crown][activeDrag.index].value;
                            const targetColor=targetInfo.type==='center'?centerColor:data[targetInfo.crown][targetInfo.index].value;
                            const fusionKey=sourceColor+'-'+targetColor;
                            
                            if(fusionRules[fusionKey]!==undefined||fissionRules[fusionKey]!==undefined){
                                activeDrag.type='fusion';
                                activeDrag.hvDirection=hvDirection;
                                activeDrag.targets=targets;
                                activeDrag.anchor.style.zIndex=200;
                            }else{
                                playBlockedSound();
                                const pastille=activeDrag.anchor.querySelector('.pastille');
                                if(pastille){pastille.classList.add('blocked');setTimeout(()=>pastille.classList.remove('blocked'),300);}
                                activeDrag=null;return;
                            }
                        }else{
                            playBlockedSound();
                            const pastille=activeDrag.anchor.querySelector('.pastille');
                            if(pastille){pastille.classList.add('blocked');setTimeout(()=>pastille.classList.remove('blocked'),300);}
                            activeDrag=null;return;
                        }
                    }
                }
            }
            
            if(activeDrag && activeDrag.type==='crownRotation'){
                const currentAngle=getAngle(x,y);
                let deltaAngle=currentAngle-activeDrag.startAngle;
                if(deltaAngle>Math.PI)deltaAngle-=2*Math.PI;
                if(deltaAngle<-Math.PI)deltaAngle+=2*Math.PI;
                const count=crowns[activeDrag.crown].count;
                const deltaPositions=(deltaAngle/(2*Math.PI))*count;
                const oldSnap=Math.round(offsets[activeDrag.crown]);
                offsets[activeDrag.crown]=activeDrag.startOffset+deltaPositions;
                if(Math.round(offsets[activeDrag.crown])!==oldSnap)playTick();
                updateAllPositions();
            }
            
            if(activeDrag && activeDrag.type==='fusion'){
                let moveDirX=0,moveDirY=0;
                if(activeDrag.hvDirection==='up')moveDirY=-1;
                else if(activeDrag.hvDirection==='down')moveDirY=1;
                else if(activeDrag.hvDirection==='left')moveDirX=-1;
                else if(activeDrag.hvDirection==='right')moveDirX=1;
                const projection=dx*moveDirX+dy*moveDirY;
                const clamped=Math.max(0,Math.min(cellSize*1.2,projection));
                activeDrag.anchor.style.left=(activeDrag.posX+moveDirX*clamped-sizeAncrage/2)+'px';
                activeDrag.anchor.style.top=(activeDrag.posY+moveDirY*clamped-sizeAncrage/2)+'px';
                activeDrag.currentProjection=clamped;
            }
            
            if(activeDrag && (activeDrag.type==='diagonal'||activeDrag.type==='centerDiagonal')){
                activeDrag.currentDx=dx;activeDrag.currentDy=dy;
            }
            
            e.preventDefault();
        }
        
        function handleEnd(e){
            if(!activeDrag)return;
            
            if(activeDrag.type==='crownRotation'){
                const crown=activeDrag.crown,count=crowns[crown].count;
                const railClass=['rail-c1','rail-c2','rail-c3'][crown];
                const rail=document.querySelector('.'+railClass);
                if(rail){rail.classList.remove('dragging');rail.classList.add('snapping');setTimeout(()=>rail.classList.remove('snapping'),300);}
                const targetOffset=Math.round(offsets[crown])%count;
                const startOffset=offsets[crown],startTime=performance.now();
                function animSnap(t){
                    const p=Math.min((t-startTime)/150,1),eased=1-Math.pow(1-p,3);
                    offsets[crown]=startOffset+(targetOffset-startOffset)*eased;
                    updateAllPositions();
                    if(p<1)requestAnimationFrame(animSnap);
                    else offsets[crown]=targetOffset;
                }
                requestAnimationFrame(animSnap);
            }
            
            if(activeDrag.type==='fusion'){
                const projection=activeDrag.currentProjection||0;
                if(projection>cellSize*0.4&&activeDrag.targets&&activeDrag.targets.length>0){
                    const targetInfo=activeDrag.targets[0];
                    const sourceColor=data[activeDrag.crown][activeDrag.index].value;
                    const targetColor=targetInfo.type==='center'?centerColor:data[targetInfo.crown][targetInfo.index].value;
                    const fusionKey=sourceColor+'-'+targetColor;
                    
                    if(fusionRules[fusionKey]!==undefined){
                        if(targetInfo.type==='center'){centerColor=fusionRules[fusionKey];updateCenterSunColor();}
                        else{data[targetInfo.crown][targetInfo.index].value=fusionRules[fusionKey];data[targetInfo.crown][targetInfo.index].elem.style.background=pastilleColors[fusionRules[fusionKey]];}
                        data[activeDrag.crown][activeDrag.index].value=6;
                        data[activeDrag.crown][activeDrag.index].elem.style.background=pastilleColors[6];
                        playFusionSound();
                    }else if(fissionRules[fusionKey]!==undefined){
                        const[c1,c2]=fissionRules[fusionKey];
                        data[activeDrag.crown][activeDrag.index].value=c1;
                        data[activeDrag.crown][activeDrag.index].elem.style.background=pastilleColors[c1];
                        if(targetInfo.type==='center'){centerColor=c2;updateCenterSunColor();}
                        else{data[targetInfo.crown][targetInfo.index].value=c2;data[targetInfo.crown][targetInfo.index].elem.style.background=pastilleColors[c2];}
                        playFissionSound();
                    }
                }
                if(activeDrag.anchor)activeDrag.anchor.style.zIndex=10;
                updateAllPositions();
            }
            
            if(activeDrag.type==='diagonal'||activeDrag.type==='centerDiagonal'){
                const dx=activeDrag.currentDx||0,dy=activeDrag.currentDy||0;
                if(Math.abs(dx)>10||Math.abs(dy)>10){
                    const angle=Math.atan2(dy,dx)*180/Math.PI;
                    let dr,dc;
                    if(angle>=-180&&angle<-90){dr=-1;dc=-1;}
                    else if(angle>=-90&&angle<0){dr=-1;dc=1;}
                    else if(angle>=0&&angle<90){dr=1;dc=1;}
                    else{dr=1;dc=-1;}
                    
                    const target=activeDrag.neighbors?activeDrag.neighbors.find(n=>n.dr===dr&&n.dc===dc):null;
                    if(target){
                        let sourceColor,targetColor;
                        if(activeDrag.type==='centerDiagonal')sourceColor=centerColor;
                        else sourceColor=data[activeDrag.crown][activeDrag.index].value;
                        targetColor=target.type==='center'?centerColor:data[target.crown][target.index].value;
                        
                        if(activeDrag.type==='centerDiagonal'){centerColor=targetColor;updateCenterSunColor();}
                        else{data[activeDrag.crown][activeDrag.index].value=targetColor;data[activeDrag.crown][activeDrag.index].elem.style.background=pastilleColors[targetColor];}
                        if(target.type==='center'){centerColor=sourceColor;updateCenterSunColor();}
                        else{data[target.crown][target.index].value=sourceColor;data[target.crown][target.index].elem.style.background=pastilleColors[sourceColor];}
                        playDiagonalSound();
                    }
                }
                document.getElementById('centerSun').classList.remove('dragging');
            }
            
            activeDrag=null;
        }
        
        function init(){
            document.querySelectorAll('.pastille-anchor').forEach(el=>el.remove());
            updateDimensions();
            sizePastille=parseInt(document.getElementById('sizePastille').value);
            sizeAncrage=parseInt(document.getElementById('sizeAncrage').value);
            radiusPastille=parseInt(document.getElementById('radiusPastille').value);
            data=[[],[],[]];offsets=[0,0,0];
            initColorPool();
            centerColor=Math.floor(Math.random()*3);
            updateCenterSunColor();
            for(let c=0;c<3;c++)for(let i=0;i<crowns[c].count;i++){
                const colorIdx=getNextColor();
                const{anchor,elem}=createPastille(colorIdx,c,i);
                data[c].push({value:colorIdx,anchor,elem});
            }
            updateAllPositions();
        }
        
        window.addEventListener('resize',()=>{updateDimensions();updateAllPositions();});
        
        const ga=document.getElementById('gameArea');
        ga.addEventListener('mousedown',handleStart);
        ga.addEventListener('touchstart',handleStart,{passive:false});
        document.addEventListener('mousemove',handleMove);
        document.addEventListener('touchmove',handleMove,{passive:false});
        document.addEventListener('mouseup',handleEnd);
        document.addEventListener('touchend',handleEnd);
        
        init();
    </script>
</body>
</html>
